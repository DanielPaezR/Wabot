<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad칤sticas - Sistema de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <h4 class="text-white text-center mb-4">
                        <i class="fas fa-chart-bar"></i> Estad칤sticas
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{{ url_for('profesional_dashboard') }}">
                                <i class="fas fa-calendar-day"></i> Citas Hoy
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="{{ url_for('profesional_estadisticas') }}">
                                <i class="fas fa-chart-bar"></i> Estad칤sticas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{{ url_for('profesional_todas_citas') }}">
                                <i class="fas fa-list"></i> Todas las Citas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt"></i> Salir
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Filtros -->
                    <div class="mt-4">
                        <label class="text-white mb-2">Mes:</label>
                        <select id="mesSelector" class="form-select">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        
                        <label class="text-white mb-2 mt-3">A침o:</label>
                        <input type="number" id="a침oSelector" class="form-control" min="2020" max="2030">
                        
                        <button id="btnActualizar" class="btn btn-primary mt-3 w-100">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Estad칤sticas del Profesional</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <span class="me-2 text-muted">游녻 {{ session.get('usuario_nombre', 'Profesional') }}</span>
                    </div>
                </div>

                <!-- Resumen General -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-primary stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="totalCitas">0</h4>
                                <p class="card-text">Total Citas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-success stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="citasCompletadas">0</h4>
                                <p class="card-text">Completadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-warning stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="citasConfirmadas">0</h4>
                                <p class="card-text">Confirmadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-info stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="ingresosTotales">$0</h4>
                                <p class="card-text">Ingresos Totales</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Segunda fila de estad칤sticas -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-secondary stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="citasCanceladas">0</h4>
                                <p class="card-text">Canceladas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-dark stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="citasSemana">0</h4>
                                <p class="card-text">Esta Semana</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-success stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="tasaExito">0%</h4>
                                <p class="card-text">Tasa de 칄xito</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="card text-white bg-primary stat-card">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="promedioIngreso">$0</h4>
                                <p class="card-text">Promedio/Cita</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gr치ficos -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-pie"></i> Distribuci칩n de Citas por Estado
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoEstados" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-bar"></i> Servicios M치s Populares
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoServicios" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Servicios Populares -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list"></i> Servicios M치s Solicitados
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Servicio</th>
                                                <th>Cantidad</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaServicios">
                                            <!-- Se llena con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Variables globales para los gr치ficos
        let chartEstados, chartServicios;
        let mesActual = new Date().getMonth() + 1;
        let a침oActual = new Date().getFullYear();

        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            configurarSelectores();
            cargarEstadisticas();
        });

        function configurarSelectores() {
            // Configurar mes y a침o actual
            document.getElementById('mesSelector').value = mesActual;
            document.getElementById('a침oSelector').value = a침oActual;

            // Event listeners
            document.getElementById('btnActualizar').addEventListener('click', cargarEstadisticas);
            document.getElementById('mesSelector').addEventListener('change', cargarEstadisticas);
            document.getElementById('a침oSelector').addEventListener('change', cargarEstadisticas);
        }

        async function cargarEstadisticas() {
            const mes = document.getElementById('mesSelector').value;
            const a침o = document.getElementById('a침oSelector').value;

            try {
                // Cargar estad칤sticas desde tu API existente
                const url = `/negocio/api/estadisticas?mes=${mes}&a침o=${a침o}&profesional_id={{ estadisticas.profesional_id if estadisticas else session.get('profesional_id', '') }}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Error al cargar estad칤sticas');
                }
                
                const stats = await response.json();
                actualizarResumen(stats.resumen);
                actualizarGraficos(stats);
                actualizarTablaServicios(stats.servicios_top);
                
            } catch (error) {
                console.error('Error cargando estad칤sticas:', error);
                mostrarError('No se pudieron cargar las estad칤sticas');
            }
        }

        function actualizarResumen(resumen) {
            document.getElementById('totalCitas').textContent = resumen.total_citas || 0;
            document.getElementById('citasCompletadas').textContent = resumen.citas_completadas || 0;
            document.getElementById('citasConfirmadas').textContent = resumen.citas_confirmadas || 0;
            document.getElementById('citasCanceladas').textContent = resumen.citas_canceladas || 0;
            document.getElementById('ingresosTotales').textContent = `$${(resumen.ingresos_totales || 0).toLocaleString()}`;
            document.getElementById('tasaExito').textContent = `${resumen.tasa_exito || 0}%`;
            
            // Calcular promedio por cita
            const promedio = resumen.total_citas > 0 ? (resumen.ingresos_totales || 0) / resumen.total_citas : 0;
            document.getElementById('promedioIngreso').textContent = `$${Math.round(promedio).toLocaleString()}`;
            
            // Citas de esta semana (usando datos existentes o c치lculo simple)
            document.getElementById('citasSemana').textContent = resumen.citas_semana || Math.round(resumen.total_citas / 4) || 0;
        }

        function actualizarGraficos(stats) {
            // Destruir gr치ficos anteriores si existen
            if (chartEstados) chartEstados.destroy();
            if (chartServicios) chartServicios.destroy();

            // Gr치fico de estados de citas
            const ctxEstados = document.getElementById('graficoEstados').getContext('2d');
            const estadosData = {
                completadas: stats.resumen.citas_completadas || 0,
                confirmadas: stats.resumen.citas_confirmadas || 0,
                canceladas: stats.resumen.citas_canceladas || 0
            };

            chartEstados = new Chart(ctxEstados, {
                type: 'doughnut',
                data: {
                    labels: ['Completadas', 'Confirmadas', 'Canceladas'],
                    datasets: [{
                        data: [estadosData.completadas, estadosData.confirmadas, estadosData.canceladas],
                        backgroundColor: [
                            'rgb(40, 167, 69)',  // Verde para completadas
                            'rgb(255, 193, 7)',  // Amarillo para confirmadas
                            'rgb(220, 53, 69)'   // Rojo para canceladas
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = estadosData.completadas + estadosData.confirmadas + estadosData.canceladas;
                                    const percentage = total > 0 ? Math.round((context.raw / total) * 100) : 0;
                                    return `${context.label}: ${context.raw} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Gr치fico de servicios populares
            const ctxServicios = document.getElementById('graficoServicios').getContext('2d');
            const servicios = stats.servicios_top || [];
            
            if (servicios.length > 0) {
                const serviciosLabels = servicios.map(s => s.nombre);
                const serviciosData = servicios.map(s => s.total_citas);

                chartServicios = new Chart(ctxServicios, {
                    type: 'bar',
                    data: {
                        labels: serviciosLabels,
                        datasets: [{
                            label: 'Citas',
                            data: serviciosData,
                            backgroundColor: 'rgb(54, 162, 235)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Cantidad de Citas'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Servicios'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            } else {
                // Mostrar mensaje si no hay datos
                document.getElementById('graficoServicios').innerHTML = 
                    '<div class="text-center text-muted p-4">No hay datos de servicios</div>';
            }
        }

        function actualizarTablaServicios(servicios) {
            const tabla = document.getElementById('tablaServicios');
            const serviciosData = servicios || [];
            
            if (serviciosData.length > 0) {
                const totalCitas = serviciosData.reduce((sum, servicio) => sum + servicio.total_citas, 0);
                
                tabla.innerHTML = serviciosData.map(servicio => {
                    const porcentaje = totalCitas > 0 ? Math.round((servicio.total_citas / totalCitas) * 100) : 0;
                    return `
                        <tr>
                            <td>${servicio.nombre}</td>
                            <td>${servicio.total_citas}</td>
                            <td>${porcentaje}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tabla.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">No hay datos de servicios</td>
                    </tr>
                `;
            }
        }

        function mostrarError(mensaje) {
            // Crear alerta de error
            const alerta = document.createElement('div');
            alerta.className = 'alert alert-danger alert-dismissible fade show';
            alerta.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insertar al inicio del main content
            const main = document.querySelector('main');
            main.insertBefore(alerta, main.firstChild);
            
            // Auto-eliminar despu칠s de 5 segundos
            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.remove();
                }
            }, 5000);
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>