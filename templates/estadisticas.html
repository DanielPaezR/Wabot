<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estadísticas - Sistema de Citas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                <div class="position-sticky pt-3">
                    <h4 class="text-white text-center mb-4">
                        <i class="fas fa-chart-bar"></i> Estadísticas
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/">
                                <i class="fas fa-calendar-day"></i> Citas Hoy
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white active" href="/estadisticas">
                                <i class="fas fa-chart-bar"></i> Estadísticas
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/configuracion">
                                <i class="fas fa-cog"></i> Configuración
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Filtros -->
                    <div class="mt-4">
                        <label class="text-white mb-2">Profesional:</label>
                        <select id="profesionalSelector" class="form-select">
                            <option value="">Todos los profesionales</option>
                        </select>
                        
                        <label class="text-white mb-2 mt-3">Mes:</label>
                        <select id="mesSelector" class="form-select">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        
                        <label class="text-white mb-2 mt-3">Año:</label>
                        <input type="number" id="añoSelector" class="form-control" value="2024">
                        
                        <button id="btnActualizar" class="btn btn-primary mt-3 w-100">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2" id="tituloEstadisticas">Estadísticas Mensuales</h1>
                </div>

                <!-- Resumen General -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-white bg-primary">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="totalCitas">0</h4>
                                <p class="card-text">Total Citas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-white bg-success">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="citasConfirmadas">0</h4>
                                <p class="card-text">Confirmadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-white bg-warning">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="ingresosTotales">$0</h4>
                                <p class="card-text">Ingresos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-white bg-info">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="clientesUnicos">0</h4>
                                <p class="card-text">Clientes Únicos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-white bg-secondary">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="tasaConfirmacion">0%</h4>
                                <p class="card-text">Tasa Confirmación</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-white bg-dark">
                            <div class="card-body text-center">
                                <h4 class="card-title" id="promedioIngreso">$0</h4>
                                <p class="card-text">Promedio/Cita</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-line"></i> Ingresos por Día
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoIngresos" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-chart-pie"></i> Servicios Más Populares
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="graficoServicios" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tablas de Datos -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-users"></i> Top Clientes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Cliente</th>
                                                <th>Citas</th>
                                                <th>Total Gastado</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaClientes">
                                            <!-- Se llena con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clock"></i> Horarios Más Populares
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Horario</th>
                                                <th>Citas</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaHorarios">
                                            <!-- Se llena con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparativa entre Profesionales -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-trophy"></i> Comparativa entre Profesionales
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Profesional</th>
                                                <th>Citas</th>
                                                <th>Confirmadas</th>
                                                <th>Ingresos</th>
                                                <th>Clientes Únicos</th>
                                                <th>Tasa Confirmación</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaComparativa">
                                            <!-- Se llena con JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Variables globales para los gráficos
        let chartIngresos, chartServicios;
        let mesActual = new Date().getMonth() + 1;
        let añoActual = new Date().getFullYear();

        // Cargar al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            cargarProfesionales();
            configurarSelectores();
            cargarEstadisticas();
        });

        function configurarSelectores() {
            // Configurar mes y año actual
            document.getElementById('mesSelector').value = mesActual;
            document.getElementById('añoSelector').value = añoActual;

            // Event listeners
            document.getElementById('btnActualizar').addEventListener('click', cargarEstadisticas);
            document.getElementById('profesionalSelector').addEventListener('change', cargarEstadisticas);
            document.getElementById('mesSelector').addEventListener('change', cargarEstadisticas);
            document.getElementById('añoSelector').addEventListener('change', cargarEstadisticas);
        }

        async function cargarProfesionales() {
            try {
                const response = await fetch('/api/profesionales');
                const profesionales = await response.json();
                
                const selector = document.getElementById('profesionalSelector');
                
                profesionales.forEach(profesional => {
                    const option = document.createElement('option');
                    option.value = profesional.id;
                    option.textContent = profesional.nombre;
                    selector.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error cargando profesionales:', error);
            }
        }

        async function cargarEstadisticas() {
            const profesionalId = document.getElementById('profesionalSelector').value;
            const mes = document.getElementById('mesSelector').value;
            const año = document.getElementById('añoSelector').value;

            try {
                // Cargar estadísticas mensuales
                const url = `/api/estadisticas/mensuales?mes=${mes}&año=${año}` + (profesionalId ? `&profesional_id=${profesionalId}` : '');
                const response = await fetch(url);
                const stats = await response.json();

                // Cargar ingresos diarios para gráfico
                const urlIngresos = `/api/estadisticas/ingresos-diarios?mes=${mes}&año=${año}` + (profesionalId ? `&profesional_id=${profesionalId}` : '');
                const responseIngresos = await fetch(urlIngresos);
                const ingresosDiarios = await responseIngresos.json();

                // Cargar comparativa entre profesionales
                const responseComparativa = await fetch(`/api/estadisticas/comparativas?mes=${mes}&año=${año}`);
                const comparativa = await responseComparativa.json();

                actualizarResumen(stats.resumen);
                actualizarGraficos(stats, ingresosDiarios);
                actualizarTablas(stats, comparativa);
                
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
            }
        }

        function actualizarResumen(resumen) {
            document.getElementById('totalCitas').textContent = resumen.total_citas;
            document.getElementById('citasConfirmadas').textContent = resumen.citas_confirmadas;
            document.getElementById('ingresosTotales').textContent = `$${resumen.ingresos_totales.toLocaleString()}`;
            document.getElementById('clientesUnicos').textContent = resumen.clientes_unicos;
            document.getElementById('tasaConfirmacion').textContent = `${resumen.tasa_confirmacion}%`;
            document.getElementById('promedioIngreso').textContent = `$${Math.round(resumen.promedio_ingreso).toLocaleString()}`;
        }

        function actualizarGraficos(stats, ingresosDiarios) {
            // Destruir gráficos anteriores si existen
            if (chartIngresos) chartIngresos.destroy();
            if (chartServicios) chartServicios.destroy();

            // Gráfico de ingresos por día
            const ctxIngresos = document.getElementById('graficoIngresos').getContext('2d');
            const dias = ingresosDiarios.map(d => d.dia);
            const ingresos = ingresosDiarios.map(d => d.ingresos);
            const citas = ingresosDiarios.map(d => d.citas);

            chartIngresos = new Chart(ctxIngresos, {
                type: 'line',
                data: {
                    labels: dias,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: ingresos,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Citas',
                            data: citas,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Ingresos ($)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Citas'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // Gráfico de servicios populares
            const ctxServicios = document.getElementById('graficoServicios').getContext('2d');
            const serviciosLabels = stats.top_servicios.map(s => s.nombre);
            const serviciosData = stats.top_servicios.map(s => s.cantidad);

            chartServicios = new Chart(ctxServicios, {
                type: 'doughnut',
                data: {
                    labels: serviciosLabels,
                    datasets: [{
                        data: serviciosData,
                        backgroundColor: [
                            'rgb(255, 99, 132)',
                            'rgb(54, 162, 235)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(153, 102, 255)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        function actualizarTablas(stats, comparativa) {
            // Tabla de clientes
            const tablaClientes = document.getElementById('tablaClientes');
            tablaClientes.innerHTML = stats.top_clientes.map(cliente => `
                <tr>
                    <td>${cliente.nombre}</td>
                    <td>${cliente.citas}</td>
                    <td>$${cliente.total_gastado.toLocaleString()}</td>
                </tr>
            `).join('');

            // Tabla de horarios
            const tablaHorarios = document.getElementById('tablaHorarios');
            tablaHorarios.innerHTML = stats.horarios_populares.map(horario => `
                <tr>
                    <td>${horario.hora}</td>
                    <td>${horario.cantidad}</td>
                </tr>
            `).join('');

            // Tabla comparativa
            const tablaComparativa = document.getElementById('tablaComparativa');
            tablaComparativa.innerHTML = comparativa.map(profesional => `
                <tr>
                    <td><strong>${profesional.nombre}</strong></td>
                    <td>${profesional.total_citas}</td>
                    <td>${profesional.citas_confirmadas}</td>
                    <td>$${profesional.ingresos.toLocaleString()}</td>
                    <td>${profesional.clientes_unicos}</td>
                    <td>${profesional.tasa_confirmacion}%</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>